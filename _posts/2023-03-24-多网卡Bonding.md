




# 多网卡Bonding

Bonding（绑定）是一种将多个网络接口（通常是以太网接口）聚合为一个逻辑接口的技术。这种聚合可以实现负载均衡、冗余和故障转移等功能。bonding 模式定义了网络接口如何在 bond 中工作。

## 1.常见的bonding模式

1. **balance-rr（模式0，Round-robin 轮询模式）**：在这种模式下，数据包按顺序分发到各个从接口，从而实现负载均衡。这种模式可以提高总体传输速率，但可能导致接收端的数据包乱序。这种模式需要交换机支持。

2. **active-backup（模式1，主备模式）**：在这种模式下，仅有一个从接口处于活动状态，其他接口处于备份状态。如果活动接口出现故障，系统会自动切换到备份接口。这种模式主要用于实现故障转移，不需要交换机支持。

3. **balance-xor（模式2，异或负载均衡模式）**：此模式根据源 MAC 地址与目标 MAC 地址的异或结果将流量分配到从接口。这可以实现负载均衡，但同一流量始终使用相同的从接口。这种模式需要交换机支持。

4. **broadcast（模式3，广播模式）**：在这种模式下，所有数据包都通过所有从接口发送。这种模式主要用于实现冗余和故障转移，不需要交换机支持。

5. **802.3ad（模式4，IEEE 802.3ad 动态链接聚合模式）**：这种模式要求交换机支持 IEEE 802.3ad LACP（Link Aggregation Control Protocol，链路聚合控制协议）。在此模式下，根据 LACP 协议的负载均衡策略将流量分配到从接口。这种模式可以提高传输速率并实现故障转移。

6. **balance-tlb（模式5，适应性传输负载均衡模式）**：此模式仅在发送流量时进行负载均衡。根据从接口的当前负载将流量分配到从接口。接收流量仅通过一个从接口。这种模式不需要交换机支持。

7. **balance-alb（模式6，适应性负载均衡模式）**：这种模式在发送和接收流量时都进行负载均衡。发送负载均衡类似于 balance-tlb 模式，而接收负载均衡则需要修改从接口的 MAC 地址。这种模式不需要交换机支持。

   每种 bonding 模式都有其特定的使用场景和优劣。在选择合适的模式时，需要考虑网络需求、交换机支持的功能以及对性能、冗余和故障转移的需求。

   例如，如果网络环境要求高可用性和故障转移，但不需要负载均衡，那么可以选择 active-backup（模式1）。如果您的网络环境支持 LACP，并要求较高的传输速率和故障转移功能，那么可以选择 802.3ad（模式4）。

## 2.配置bonding模式

> 案例：我们有eth0、eth1两个网卡，模式使用active-backup

### 2.1使用nmcli命令配置

在 Linux 系统中，配置 bonding 模式的方法有很多，这里我将以使用 NetworkManager 的命令行工具 `nmcli` 为例来演示如何配置 bonding 模式。

以下是使用 `nmcli` 配置 bonding 的步骤：

1. 首先，创建一个新的 bond 连接。您需要指定 bond 的名称（例如 `mybond0`）和网络接口名称（例如 `bond0`）。同时，您需要为 bond 连接设置一个模式（例如 `mode=active-backup`）。执行以下命令：

```css
nmcli con add type bond con-name mybond0 ifname bond0 mode active-backup(需要执行第三步)
或者
nmcli con add type bond con-name mybond0 ifname bond0 mode active-backup ipv4.method manual ipv4.addresses 10.0.0.100/24(不需要执行第三步)
```

2. 将物理接口添加到 bond 连接。请根据您的实际网络接口名称替换 eth0 和 eth1。执行以下命令：

```css
nmcli con add type ethernet con-name mybond0-eth0 ifname eth0 master bond0	#bond0要跟上面ifname 后面的名字对应
nmcli con add type ethernet con-name mybond0-eth1 ifname eth1 master bond0
或者
nmcli con add type bond-slave con-name mybond0-eth0 ifname eth0 master bond0
nmcli con add type bond-slave con-name mybond0-eth1 ifname eth1 master bond0
```

可以将 `type ethernet` 替换为 `type bond-slave`。实际上，在某些发行版中，它们是等效的。当您将一个网络接口添加到 bond 连接时，指定 `type bond-slave` 可以使语义更清晰，因为它明确表示您将该接口作为从接口添加到 bond 连接。

3. 配置 bond 接口的 IP 地址、子网掩码、默认网关和 DNS（可选）。例如，要配置静态 IP 地址，请执行以下命令：

```css
nmcli con modify mybond0 ipv4.method manual ipv4.addresses 10.0.0.100/24 ipv4.gateway 10.0.0.1 ipv4.dns "8.8.8.8, 8.8.4.4"
```

4. 启用 bond 连接：

```css
nmcli con up mybond0
```

5. 验证 bond 连接配置。要查看 bond 连接的详细信息，请执行以下命令：

```css
nmcli con show mybond0
```

还可以使用 `cat` 命令查看 `/proc/net/bonding/bond0` 文件，以获取有关 bond 接口状态的详细信息：

```css
cat /proc/net/bonding/bond0  #可以看到两个网卡中哪个是备份，哪个是主
```

### 2.2.使用配置文件的方式

在基于 RHEL 和 CentOS 的系统中，您可以使用 `ifcfg-*` 配置文件来配置 bonding。以下是使用配置文件配置 active-backup 模式的步骤：

1. 首先，创建一个名为 `ifcfg-bond0` 的 bond 配置文件。在 `/etc/sysconfig/network-scripts/` 目录下创建一个新文件：

```css
sudo nano /etc/sysconfig/network-scripts/ifcfg-bond0
```

2. 在 `ifcfg-bond0` 文件中添加以下内容：

```bash
DEVICE=bond0
NAME=bond0
TYPE=Bond
BONDING_MASTER=yes
IPADDR=10.0.0.100
PREFIX=24
GATEWAY=10.0.0.1
DNS1=8.8.8.8
DNS2=8.8.4.4
ONBOOT=yes
BOOTPROTO=none
BONDING_OPTS="mode=active-backup miimon=100 fail_over_mac=1" #也可以写成BONDING_OPTS="mode=1 miimon=100"

#mode=1：这表示 bonding 的模式是 active-backup（模式1），在这种模式下，只有一个从接口是活动的，其他接口则处于备用状态。当活动接口失效时，备用接口将接管流量。
#miimon=100：这是一个用于监控网络接口链路状态的参数。它表示每100毫秒（ms）检查一次链路状态。如果检测到链路故障，系统将自动切换到其他可用的接口。
#fail_over_mac=1：此参数用于配置 MAC 地址的故障转移策略。fail_over_mac=1 表示 bonding 设备将使用活动从接口的 MAC 地址。当从接口发生切换时，bonding 设备的 MAC 地址也会相应地更改。这个可以不写。综上所述，BONDING_OPTS="mode=1 miimon=100 fail_over_mac=1" 表示配置 bonding 设备为 active-backup 模式，每 100ms 检查一次接口链路状态，并在故障转移时更改 bonding 设备的 MAC 地址。
```

3. 修改您的网络接口（eth0 和 eth1）的配置文件。打开 `/etc/sysconfig/network-scripts/ifcfg-eth0` 和 `/etc/sysconfig/network-scripts/ifcfg-eth1`，并修改它们的内容以指向 bond0：

对于 `ifcfg-eth0`：

```bash
DEVICE=eth0
TYPE=Ethernet
BOOTPROTO=none
ONBOOT=yes
MASTER=bond0
SLAVE=yes
```

对于 `ifcfg-eth1`：

```bash
DEVICE=eth1
TYPE=Ethernet
BOOTPROTO=none
ONBOOT=yes
MASTER=bond0
SLAVE=yes

#MASTER=bond0：这表示此网络接口（eth1）的主设备是 bond0。换句话说，eth1 将成为 bond0 的一个从接口（slave interface），与其他从接口一起共享 bond0 的负载。
#SLAVE=yes：此选项指示该网络接口（eth1）是一个从接口。将 SLAVE 设置为 yes 表示 eth1 是 bond0 的从接口，将根据 bonding 配置的模式和策略与其他从接口一起工作。
```

4. 保存并关闭所有打开的配置文件。

5. 重启网络服务以使更改生效：

```css
sudo systemctl restart network
```

6. 或者，在 CentOS 8 或 RHEL 8 上：

```css
sudo nmcli connection reload
sudo nmcli connection down bond0
sudo nmcli connection up bond0
```

7. 验证 bond 配置。要查看 bond 接口的详细信息，请执行以下命令：

```css
cat /proc/net/bonding/bond0
```

以上步骤应该可以帮助您使用配置文件在基于 RHEL 和 CentOS 的系统中配置 bonding 的 active-backup 模式。请注意，在其他发行版（如 Debian 和 Ubuntu）上，配置文件和步骤可能会有所不同。

## 3.CentOS7配置bonding模式

### 3.1使用nmcli命令配置

在 CentOS 7 中，`nmcli` 命令也可以用于配置 bonding。同时，CentOS 7 中确实引入了一个名为 `team` 的新特性，它可以作为 bonding 的替代方案。但是在这里，我们仍然将介绍如何使用 `nmcli` 配置 bonding，而不是 team。

下面是使用 `nmcli` 在 CentOS 7 中配置 bonding 的步骤：

1. 创建一个名为 bond0 的新 bond 连接：

```css
sudo nmcli con add type bond con-name bond0 ifname bond0 mode active-backup
```

1. 为 bond0 分配一个静态 IP 地址、子网掩码、默认网关和 DNS 服务器：

```css
sudo nmcli con mod bond0 ipv4.addresses "10.0.0.100/24" ipv4.gateway "10.0.0.1" ipv4.dns "8.8.8.8,8.8.4.4" ipv4.method manual
```

请根据您的网络环境替换 IP 地址、子网掩码、默认网关和 DNS 服务器。

1. 将您的网络接口（例如 eth0 和 eth1）添加为 bond0 的从接口：

```css
sudo nmcli con add type ethernet con-name bond0-eth0 ifname eth0 master bond0
sudo nmcli con add type ethernet con-name bond0-eth1 ifname eth1 master bond0
```

1. 最后，启用 bond0 连接：

```css
sudo nmcli con up bond0
```

1. 可以通过以下命令验证 bond 配置：

```css
nmcli con show bond0
```

这样，您就可以使用 `nmcli` 命令在 CentOS 7 中配置 bonding 了。如果您想使用 team 而非 bonding，配置过程将略有不同。

### 3.2使用配置文件的方式

在 CentOS 7 中配置 bonding 模式的方法与 CentOS 6 和 RHEL 系列非常相似。您可以使用 `ifcfg-*` 配置文件来配置 bonding。以下是如何在 CentOS 7 中配置 bonding 的步骤：

1. 首先，加载 bonding 内核模块。您可以通过执行以下命令来实现：

```css
sudo modprobe bonding
```

1. 创建一个名为 `ifcfg-bond0` 的 bond 配置文件。在 `/etc/sysconfig/network-scripts/` 目录下创建一个新文件：

```css
sudo nano /etc/sysconfig/network-scripts/ifcfg-bond0
```

1. 在 `ifcfg-bond0` 文件中添加以下内容：

```css
DEVICE=bond0
NAME=bond0
TYPE=Bond
BONDING_MASTER=yes
IPADDR=10.0.0.100
PREFIX=24
GATEWAY=10.0.0.1
DNS1=8.8.8.8
DNS2=8.8.4.4
ONBOOT=yes
BOOTPROTO=none
BONDING_OPTS="mode=active-backup miimon=100"
```

请根据您的网络环境替换 IP 地址、子网掩码、默认网关和 DNS 服务器。在 BONDING_OPTS 中，`mode=active-backup` 表示我们在这里使用 active-backup（模式1）。`miimon=100` 表示每 100 毫秒检查一次接口的链路状态。

1. 修改您的网络接口（eth0 和 eth1）的配置文件。打开 `/etc/sysconfig/network-scripts/ifcfg-eth0` 和 `/etc/sysconfig/network-scripts/ifcfg-eth1`，并修改它们的内容以指向 bond0：

对于 `ifcfg-eth0`：

```css
DEVICE=eth0
TYPE=Ethernet
BOOTPROTO=none
ONBOOT=yes
MASTER=bond0
SLAVE=yes
```

对于 `ifcfg-eth1`：

```css
DEVICE=eth1
TYPE=Ethernet
BOOTPROTO=none
ONBOOT=yes
MASTER=bond0
SLAVE=yes
```

1. 保存并关闭所有打开的配置文件。
2. 重启网络服务以使更改生效：

```css
sudo systemctl restart network
```

1. 验证 bond 配置。要查看 bond 接口的详细信息，请执行以下命令：

```css
cat /proc/net/bonding/bond0
```

以上步骤应该可以帮助您在 CentOS 7 中配置 bonding 模式。在其他发行版（如 Debian、Ubuntu 或其他基于 RHEL 的发行版）上，配置文件和步骤可能会有所不同。

### 3.3.CentOS7配置team模式

在 CentOS 7 中，可以使用 `nmcli` 命令来配置 team。以下是使用 `nmcli` 配置 team 的步骤：

1. 首先，安装 `teamd` 软件包（如果尚未安装）：

```css
sudo yum install -y teamd
```

1. 使用 `nmcli` 创建一个名为 team0 的新 team 连接：

```css
sudo nmcli con add type team con-name team0 ifname team0
```

1. 为 team0 分配静态 IP 地址、子网掩码、默认网关和 DNS 服务器：

```css
sudo nmcli con mod team0 ipv4.addresses "10.0.0.100/24" ipv4.gateway "10.0.0.1" ipv4.dns "8.8.8.8,8.8.4.4" ipv4.method manual
```

请根据您的网络环境替换 IP 地址、子网掩码、默认网关和 DNS 服务器。

1. 定义 team 连接的配置文件。在本例中，我们将使用默认的 round-robin（循环）运行模式。创建一个名为 `team-config.json` 的文件，并添加以下内容：

```css
{
    "device": "team0",
    "runner": {
        "name": "roundrobin"
    }
}
```

1. 将配置文件应用到 team0 连接：

```css
sudo nmcli con mod team0 team.config "$(cat team-config.json)"
```

1. 将您的网络接口（例如 eth0 和 eth1）添加为 team0 的端口：

```css
sudo nmcli con add type team-slave con-name team0-eth0 ifname eth0 master team0
sudo nmcli con add type team-slave con-name team0-eth1 ifname eth1 master team0
```

1. 启用 team0 连接：

```css
sudo nmcli con up team0
```

1. 验证 team 配置：

```css
nmcli con show team0
```

现在您已经使用 `nmcli` 命令在 CentOS 7 中配置了一个 team。这个示例使用了 round-robin（循环）运行模式，但 team 支持其他运行模式，如 broadcast、active-backup 等。要使用其他运行模式，只需在 `team-config.json` 文件中修改相应的设置。
