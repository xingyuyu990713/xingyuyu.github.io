






> TCP（Transmission Control Protocol）是一种可靠的传输协议，用于在网络上建立可靠的数据传输通道。TCP协议中的三次握手和四次分手是建立和终止TCP连接时必须经过的过程。

## TCP三次握手

> TCP三次握手是建立TCP连接的过程，通过三次握手，发送方和接收方可以建立一个可靠的连接，确保数据能够安全可靠地传输。

TCP三次握手是TCP协议用于建立可靠连接的过程。以下是TCP三次握手的详细步骤：

1. 第一次握手（SYN）：

客户端向服务器发送一个SYN报文段（SYN = Synchronize Sequence Numbers），其中SYN标志位被置为1，其中包含自己的随机初始序列号（ISN）,并且该报文段不包含数据，表示发送方请求建立连接。

2. 第二次握手（SYN+ACK）：

服务器接收到客户端的SYN报文段后，返回一个SYN+ACK（同步序列编号+确认序列编号）报文段，其中确认序列号为客户端的SIN+1，同时也包含自己的初始系列号（ISN），该报文段中SYN和ACK标志位都被置为1，表示确认建立连接，并且该报文段也包含数据。（SYN+ACK=Synchronize Acknowledgement）

3. 第三次握手（ACK）：

客户端收到服务器的SYN-ACK报文段后，客户端向服务器发送一个ACK（确认）报文段（ACK=Acknowledge）。该报文段中ACK标志位被置为1，表示客户端已经收到了服务器的SYN-ACK报文段，并向服务器发送确认信息。此时，TCP连接建立成功，可以进行数据传输。

TCP三次握手的过程保证了发送方和接收方之间的连接是可靠的，并且双方都同意建立连接。这也是TCP协议成为可靠传输协议的重要原因之一。

<img src="https://typora-images-1307361841.cos.ap-beijing.myqcloud.com/img/image-20230315153842398.png" alt="image-20230315153842398" style="zoom:50%;" /> 

### 通俗理解

三次握手的过程可以类比为两个人握手。假设A和B两个人见面，要进行握手表示建立联系。握手的过程如下：

1. A向B伸出手并说：“你好，我是A，你愿意和我握手吗？”
2. B看到A的手，想要与A握手，于是回答：“你好，我是B，我愿意和你握手。”同时，B也向A伸出手。
3. A看到B的手，确认对方愿意与自己握手，于是回答：“好的，我们握手吧。”然后与B握手。

类比到TCP三次握手的过程中，A和B分别表示发送方和接收方，握手的过程中发送方发送SYN报文段表示请求建立连接，接收方发送SYN+ACK报文段表示同意建立连接，最后发送方再发送ACK报文段表示确认连接建立成功。

## TCP四次分手

> TCP四次分手是终止TCP连接的过程，通过四次分手，发送方和接收方可以完成数据传输，释放连接资源。

1. 第一次分手（FIN）：

客户端向服务器发送一个FIN报文段（FIN=Finish），表示客户端不再发送数据，并请求关闭连接。

2. 第二次分手（ACK）：

服务器收到FIN报文段后，会向客户端发送一个ACK报文段，表示服务器已经成功接收客户端的FIN报文段，并向客户端发送确认信息。

3. 第三次分手（FIN）：

服务器向客户端发送一个FIN报文段，表示服务器也不再发送数据，并请求关闭连接。

4. 第四次分手（ACK）：

客户端收到服务器发送的FIN报文段后，向服务器发送一个ACK报文段，表示客户端已经成功收到了服务器的FIN报文段，并向服务器发送确认信息。此时，TCP连接已经完全终止，连接资源被释放。

在TCP四次分手的过程中，有一个TIME_WAIT状态，是为了防止出现“半开连接”的情况，保证连接的正确关闭。在客户端发送最后一个ACK报文段之后，会进入TIME_WAIT状态，等待2倍MSL（Maximum Segment Lifetime，最大报文段生存时间）时间，确保所有的数据都已经传输完成。如果在TIME_WAIT状态期，接收到了服务器发送的FIN报文段，说明服务器并没有接收到ACK报文段，此时客户端需要重新发送ACK报文段。如果超过2倍MSL时间后还没有收到服务器发送的FIN报文段，客户端就可以结束TIME_WAIT状态，释放连接资源。

需要注意的是，在TCP连接的建立和终止过程中，如果其中一方没有按照规定的步骤进行操作，或者出现网络故障等情况，就会导致TCP连接无法正常建立或者终止。比如，如果只进行了两次握手，就可以伪造一个TCP连接，这就是TCP的SYN攻击。因此，TCP协议的安全性也成为网络安全的重要问题之一。

<img src="https://typora-images-1307361841.cos.ap-beijing.myqcloud.com/img/image-20230315170411941.png" alt="image-20230315170411941" style="zoom:50%;" /> 

### 通俗理解

四次分手的过程也可以类比为两个人分手。假设A和B两个人要结束会面，进行分手的过程如下：

1. A对B说：“很高兴能与你见面，我们该结束了。”然后A离开。
2. B回答：“好的，我们下次再见。”
3. 然后，B也告诉A：“请确认收到我的消息。”
4. A回答：“好的，我已经收到了，再见。”最后A也离开。

类比到TCP四次分手的过程中，A和B分别表示发送方和接收方，分手的过程中发送方发送FIN报文段表示请求关闭连接，接收方发送ACK报文段表示已经收到请求，然后接收方也发送FIN报文段表示也要关闭连接，最后发送方再发送ACK报文段表示确认连接关闭成功。

## 六大标志位

> TCP中有六大标志位：SYN、ACK、FIN，这三个最为重要，还有URG、PSH、RSE，这些都是TCP协议中的控制标志（Control flag），用来控制TCP报文段的行为。

SYN表示“同步”，它是一个请求标志位，用于告诉接收方，发送方打算建立一个新的TCP连接。SYN报文段中，SYN标志位被设置为1，其余标志位被设置为0。

ACK表示“确认”，它是一个响应标志位，用于告诉发送方，接收方已经收到了发送方发送的报文段。ACK报文段中，ACK标志位被设置为1，其余标志位被设置为0。

在TCP三次握手过程中，当发送方向接收方发送一个SYN报文段时，接收方会回复一个SYN-ACK报文段，其中SYN和ACK标志位都被设置为1。这意味着接收方同意建立连接，并且向发送方发送确认报文段。接收方的SYN报文段中的SYN标志位告诉发送方，接收方已经收到了发送方的SYN报文段，而SYN-ACK报文段中的ACK标志位告诉发送方，接收方已经确认了建立连接的请求。

当发送方收到接收方的SYN-ACK报文段后，会向接收方发送一个ACK报文段，其中ACK标志位被设置为1。这意味着发送方已经收到了接收方的确认报文段，连接已经建立成功。

因此，SYN和ACK标志位在TCP协议中是非常重要的标志位，它们用于确保TCP连接的可靠性和正确性。

1. SYN（Synchronize）标志位：用于建立连接时的握手过程。发送端发送一个SYN报文段，请求建立连接，同时SYN标志位为1。接收端收到SYN报文段后，回复一个SYN+ACK报文段，表示同意建立连接，SYN和ACK标志位都为1。这是TCP三次握手的第一步和第二步。
2. ACK（Acknowledgment）标志位：用于确认接收方是否正确接收到了报文段。在正常的数据传输过程中，发送端发送一个包含数据的TCP报文段，ACK标志位为1，表示接收方需要确认这个报文段已经被正确接收。接收方在正确接收到报文段后，回复一个ACK报文段，表示已经正确接收到。
3. FIN（Finish）标志位：用于关闭TCP连接时的四次分手过程。发送方向接收方发送一个FIN报文段，表示不再发送数据，请求关闭连接。接收方收到FIN报文段后，回复一个ACK报文段，表示已经收到请求，但仍然可以发送数据。当接收方也准备好关闭连接时，会向发送方发送一个FIN报文段，请求关闭连接。发送方收到FIN报文段后，回复一个ACK报文段，表示确认关闭连接。这是TCP四次分手的最后一步。
4. URG（Urgent）标志位：当这个标志位为1时，表示紧急指针（urgent pointer）字段有效，紧急指针用于指示紧急数据的边界，通常用于实时通信等场景。
5. PSH（Push）标志位：当这个标志位为1时，表示接收方应该尽快将数据交给应用程序，而不是等到缓冲区满了再交给应用程序。
6. RST（Reset）标志位：当这个标志位为1时，表示重置TCP连接，通常用于中断连接或者发生错误时。

## 三次握手包含的状态

1. CLOSED（关闭）状态：表示TCP连接处于关闭状态，没有任何活动或连接。

2. SYN-SENT（SYN已发送）状态：表示TCP连接正在尝试建立中，已经发送了SYN报文段，等待对方回复ACK报文段。

3. SYN-RECEIVED（SYN已接收）状态：表示TCP连接正在尝试建立中，已经接收到对方的SYN报文段，同时也已经发送了ACK报文段，等待对方的ACK报文段。

4. ESTABLISHED（已建立）状态：表示TCP连接已经建立，双方可以进行数据传输和通信。

5. MSL（Maximum Segment Lifetime）是指TCP数据包在网络上存活的最长时间。当TCP协议在进行数据传输时，每个数据包都会携带一个TTL（Time To Live）字段，用于表示数据包在网络上可以存活的时间。MSL是TCP协议中的一个重要参数，它表示一个TCP数据包在网络上存活的最长时间，通常为2倍的最大分段大小（MSS）。在MSL时间到达后，如果该数据包仍未被接收方确认，则该数据包将被网络丢弃，发送方需要重新发送数据。

   MSL的设置是为了避免已失效的数据包在网络上无限期地循环，浪费网络资源。同时，MSL还能保证连接的安全性，因为连接断开后的一段时间内，原有的数据包可能仍然存在于网络中，如果这些数据包被恶意攻击者拦截，可能会对连接造成风险。

   在TCP连接断开时，通常需要经过4次握手，其中最后一次FIN ACK报文段被发送后，需要等待2倍MSL的时间，以确保连接中所有数据包都已经被完全接收和处理，从而避免可能的数据包重复和混乱

### 为什么需要两倍MSL时间？

根据搜索结果，需要两倍MSL时间的原因有两个：

- 确保最后一个ACK包能够到达被动关闭方，如果ACK包丢失，被动关闭方会重发FIN包，主动关闭方可以再次发送ACK包并重新计时。
- 确保旧的TCP报文段在网络上失效，防止它们干扰新的连接。如果不等待两倍MSL时间，可能会出现旧的TCP报文段与新的连接使用相同的源地址、源端口、目标地址和目标端口而导致顺序混乱或数据错误。

## 四次分手包含的状态

1. FIN-WAIT-1（等待终止-1）状态：表示TCP连接正在关闭中，已经发送了FIN报文段，等待对方回复ACK报文段。
2. FIN-WAIT-2（等待终止-2）状态：表示TCP连接正在关闭中，已经接收到对方的ACK报文段，等待对方发送FIN报文段。
3. TIME-WAIT（时间等待）状态：表示TCP连接已经关闭，但是还需要等待一段时间，以确保所有的报文段都已经被正确处理。TCP的TIME-WAIT状态是主动关闭方在结束TCP连接时进入的一种状态。它的作用是确保最后一个ACK包能够达到被动关闭方，以及防止旧的TCP报文段干扰新的连接。TIME-WAIT状态是持续两倍MSL时间，然后主动关闭方释放资源。
4. CLOSE-WAIT（等待关闭）状态：表示TCP连接正在关闭中，已经接收到对方的FIN报文段，等待本地应用程序关闭连接。
5. LAST-ACK（最后确认）状态：表示TCP连接正在关闭中，已经接收到对方的FIN报文段和ACK报文段，向对方发送最后一个ACK报文段，完成关闭连接。

TCP的四次分手过程中，还有一个CLOSING（关闭中）状态，表示双方都已经发送了FIN报文段，但是还没有完全关闭连接。但是在实际应用中，这个状态并不常见，大多数情况下只需要用到上述的状态即可。

## 为什么tcp握手是三次，不是两次？

TCP采用三次握手是为了保证连接的可靠性和正确性，防止出现不必要的错误和重复数据传输。具体来说，TCP采用三次握手的原因包括以下几点：

1. 防止已失效的连接请求到达服务器：在第一次握手时，客户端向服务器发送SYN报文段，请求建立连接。如果该SYN报文段因网络延迟或其他原因长时间未被服务器收到，客户端可能会再次发送一个SYN报文段。如果此时客户端之前发送的SYN报文段已经到达服务器，但尚未被服务器处理，那么服务器会认为这是一个新的连接请求，进而发送SYN+ACK报文段给客户端，导致连接建立错误。采用三次握手可以避免这种情况的发生，保证只有合法的连接请求被处理。
2. 确认双方的接收和发送能力：在第二次握手时，服务器接收到客户端发送的SYN报文段，返回SYN+ACK报文段，并且为自己的数据包分配一个序列号。此时服务器确认自己的接收和发送能力都正常，客户端也可以确认服务器的接收和发送能力正常。在第三次握手时，客户端接收到服务器发送的SYN+ACK报文段，并为自己的数据包分配一个序列号，确认自己的接收和发送能力正常，同时也确认了服务器的接收和发送能力正常。
3. 避免网络延迟导致的重复数据传输：如果采用两次握手，当客户端发送一个SYN报文段请求建立连接时，由于网络延迟，该报文段可能会在一定时间后才到达服务器，此时服务器返回一个SYN+ACK报文段，表示接受请求。但是由于网络延迟，客户端并未收到该SYN+ACK报文段，而服务器却认为连接已经建立成功。当客户端再次发送一个SYN报文段时，由于之前的连接还未正式关闭，服务器会认为这是一个重复的连接请求，返回之前已经发送过的SYN+ACK报文段，导致客户端出现重复数据传输的问题。采用三次握手可以避免这种情况的发生。

综上所述，TCP采用三次握手是为了保证连接的可靠性和正确性，避免出现不必要的错误和重复数据传输。

